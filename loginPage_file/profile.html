<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Create Profile | SMU Event Helpers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(135deg, #d6e4ff, #f8f9fa);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Poppins", sans-serif;

      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: white;
      background-image: url("../homePage/img/blog2.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

    }

    .card {
      max-width: 500px;
      border: none;
      border-radius: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
    }

    .card-header {
      background: #004aad;
      color: #fff;
      text-align: center;
      padding: 1.5rem;
    }

    .form-label {
      font-weight: 500;
      color: wheat;
    }

    .btn-success {
      background-color: #007bff;
      border-radius: 50px;
      font-weight: 600;
      margin: 6px 0;
    }

    .btn-success:hover {
      background-color: rgb(41, 41, 255);
    }


    input,
    textarea {
      border-radius: 10px !important;
    }

    .form-control:focus {
      border-color: #004aad;
      box-shadow: 0 0 0 0.2rem rgba(0, 74, 173, 0.25);
    }

    #otherSkillBox {
      display: none;
      margin-top: 10px;
    }

    .profile-pic-container {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      width: 110px;
    }

    .profile-pic-container:hover .upload-overlay {
      opacity: 1;
    }

    .profile-pic {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #faf9ff;
      background: #e7e7f7;
      display: block;
    }

    img[alt="Picture"] {
      padding-top: 25px;
      text-align: center;
      justify-content: center;
    }

    .upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
      color: white;
      font-size: 0.85rem;
      text-align: center;
      padding: 10px;
      pointer-events: none;
    }

    #fileInput {
      display: none;
    }

    #profile {
      color: white;
      text-align: center;
      padding: 1.5rem;
    }

    .btn {
      border-radius: 50px;
      font-weight: 600;
      margin: 6px 0;
      background-color: #007bff;
      ;
      border: none;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="card col-md-6 col-lg-4 mx-auto">
    <h2 id="profile">Create Profile</h2>
    <div class="profile-pic-container" id="profilePicContainer">
      <img id="profilePic" src="../loginPage_file/default-avatar.png" alt="Picture" class="profile-pic" />
      <div class="upload-overlay">
        <span>ðŸ“· Upload Photo</span>
      </div>
    </div>
    <input type="file" id="fileInput" accept="image/*" />
    <div class="card-body p-4">
      <form id="profileForm">
        <div class="mb-3">
          <label for="fullname" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="fullname" name="fullname" required placeholder="E.g. John Doe" />
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="phone" name="phone" required pattern="[0-9]{8,15}"
            placeholder="E.g. 91234567" />
        </div>
        <div class="mb-3">
          <label class="form-label">Role</label>
          <div>
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="roleHelper" name="role" value="helper" required />
              <label class="form-check-label" for="roleHelper">Helper</label>
            </div>
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="roleAdmin" name="role" value="club admin" required />
              <label class="form-check-label" for="roleAdmin">Club Admin</label>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Skills</label>
          <div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="skill1" name="skills" value="First Aid" />
              <label class="form-check-label" for="skill1">First Aid</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="skill2" name="skills" value="Crowd Control" />
              <label class="form-check-label" for="skill2">Crowd Control</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="skill3" name="skills" value="Photography" />
              <label class="form-check-label" for="skill3">Photography</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="skill4" name="skills" value="Logistics" />
              <label class="form-check-label" for="skill4">Logistics</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="skillOther" name="skills" value="Others" />
              <label class="form-check-label" for="skillOther">Others</label>
            </div>
            <div id="otherSkillBox">
              <input type="text" class="form-control mt-2" id="otherSkill" name="otherSkill"
                placeholder="Please specify your skill" />
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 py-2 mt-2">Create Profile</button>
      </form>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByPrDz810_ttwZz0BdAJkeP54rMIqH3uw",
      authDomain: "wad2-505be.firebaseapp.com",
      databaseURL: "https://wad2-505be-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wad2-505be",
      storageBucket: "wad2-505be.firebasestorage.app",
      messagingSenderId: "221863917439",
      appId: "1:221863917439:web:2a517ca11c83e991388c4a",
      measurementId: "G-L69GG585GF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in, see docs for a list of available properties
        const uid = user.uid;
        let profileExist = false;
        // Create a reference to the users collection
        const profilesRef = collection(db, "profiles");
        // Create a query against the collection
        const q = query(profilesRef, where("userId", "==", user.uid));
        // Fetch matching documents
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach((doc) => {
          profileExist = true;
          localStorage.setItem('profileID', doc.id)
        });
        if (profileExist) {
          window.location.replace("../homepage/index.html");
        }
      } else {
        // User is signed out
        window.location.replace("./login.html");
      }
    });


    let uploadedPhotoUrl = null;

    // Click on profile picture to upload
    document.getElementById("profilePicContainer").onclick = () => {
      document.getElementById("fileInput").click();
    };

    // Handle file selection
    document.getElementById("fileInput").onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert("Please select an image file.");
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert("Image size should be less than 5MB.");
        return;
      }
      const reader = new FileReader();
      reader.onload = (event) => {
        document.getElementById("profilePic").src = event.target.result;
      };
      reader.readAsDataURL(file);

      try {
        const user = auth.currentUser;
        if (!user) {
          alert("You must be logged in to upload a photo.");
          return;
        }

        const storageRef = ref(storage, `profile_photos/${user.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        uploadedPhotoUrl = await getDownloadURL(storageRef);
        document.getElementById("profilePic").src = uploadedPhotoUrl;
      } catch (error) {
        console.error("Error uploading photo:", error);
        alert("Failed to upload photo. Please try again.");
      }
    };

    // Show/hide "Other Skill" textbox based on checkbox
    document.getElementById("skillOther").addEventListener("change", function () {
      document.getElementById("otherSkillBox").style.display =
        this.checked ? "block" : "none";
    });

    let user = null;
    onAuthStateChanged(auth, (u) => {
      if (!u) {
        alert("You must be logged in to create profile!");
        window.location.href = "../loginPage_file/login.html";
        return;
      }
      user = u;

      document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get selected skills
        const selectedSkills = [];
        document.querySelectorAll('input[name="skills"]:checked').forEach((cb) => {
          if (cb.value === "Others") {
            const otherSkill = document.getElementById("otherSkill").value.trim();
            if (otherSkill) selectedSkills.push(otherSkill);
          } else {
            selectedSkills.push(cb.value);
          }
        });

        // Get selected role
        const roleRadio = document.querySelector('input[name="role"]:checked');
        const selectedRole = roleRadio ? roleRadio.value : "";

        const data = {
          fullname: document.getElementById("fullname").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          role: selectedRole,
          skills: selectedSkills,
          userId: user.uid,
          email: user.email,
          createdAt: new Date().toISOString()
        };

        if (uploadedPhotoUrl) {
          data.photoUrl = uploadedPhotoUrl;
        }

        try {
          await addDoc(collection(db, "profiles"), data);
          alert("Profile created!");

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              // User is signed in, see docs for a list of available properties
              const uid = user.uid;
              // Create a reference to the users collection
              const profilesRef = collection(db, "profiles");
              // Create a query against the collection
              const q = query(profilesRef, where("userId", "==", user.uid));
              // Fetch matching documents
              const querySnapshot = await getDocs(q);
              querySnapshot.forEach((doc) => {
                localStorage.setItem('profileID', doc.id)
              });
            }
          });
          
          window.location.href = "../homePage/events.html";
        } catch (error) {
          console.error("Error saving profile:", error);
          alert("Failed to create profile. Please try again.");
        }
      });
    });
  </script>
</body>

</html>