<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8" />
    <title>Manage Rewards | SMU Event Helpers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body {
            background: linear-gradient(135deg, #d6e4ff, #f8f9fa);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Poppins", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            background-image: url("../homePage/img/blog2.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .card {
            max-width: 450px;
            border-radius: 20px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            background-color: rgba(0, 0, 0, 0.7);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: #004aad;
            color: #fff;
            text-align: center;
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #333;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
            font-weight: 600;
            transition: background-color 0.3s ease-in-out;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        input,
        textarea {
            border-radius: 10px !important;
        }

        .form-control:focus {
            border-color: #004aad;
            box-shadow: 0 0 0 0.2rem rgba(0, 74, 173, 0.25);
        }

        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        #event {
            color: white;
            text-align: center;
            padding: 1.5rem;
        }

        .form-label {
            color: white;
        }

        .btn {
            border-radius: 50px;
            font-weight: 600;
            margin: 6px 0;
            background-color: #007bff;
            ;
            border: none;
            font-weight: 600;
        }

        .btn:hover {
            background-color: rgb(41, 41, 255);
        }
    </style>
</head>

<body>
    <div class="card">
        <h2 id="reward" class="bi bi-calendar-event me-2">Add Reward</h2>
        <div class="card-body p-4">
            <form id="rewardForm">
                <div class="mb-3">
                    <label for="rewardName" class="form-label">Name of Reward</label>
                    <input type="text" class="form-control" id="rewardname" name="rewardName" required />
                </div>

                <div class="mb-3">
                    <label for="pointsAmount" class="form-label">Points Amount</label>
                    <input type="number" class="form-control" id="pointsAmount" name="pointsAmount" required />
                </div>

                <div class="mb-3">
                    <label for="redeemLimit" class="form-label">Redeem Limit</label>
                    <input type="number" class="form-control" id="redeemLimit" name="redeemLimit" required />
                </div>

                <button type="submit" class="btn btn-success w-100 py-2 mt-2">
                    <i class="bi bi-plus-circle me-2"></i>Add reward
                </button>
            </form>
        </div>
    </div>
    <div id="rewardList">
        <table class="table table-bordered" id="rewardTable">
            <tr>
                <th>Number</th>
                <th>Reward name</th>
                <th>Redeemed Users</th>
                <th>Delete</th>
            </tr>
        </table>

    </div>

    <div>
        <button type="button" id="returnButton">Return</button>
        <script>
            function doSomething(){
                window.location.replace("./points.html");
            }
            let returnButton = document.getElementById('returnButton');
            returnButton.addEventListener("click",doSomething);

        </script>
    </div>

   
    <script type="module">
        // Check if logged in
        import { checkLogin } from "../loginPage_file/authenticate.js";

        checkLogin()

        // Check if role is System Admin
        import { getRole } from '../reward/reward.js'
        let profileID = localStorage.getItem('profileID');
        let role = await getRole(profileID);
        if (role != 'systemAdmin') {
            window.location.replace('./index.html');
        }


        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByPrDz810_ttwZz0BdAJkeP54rMIqH3uw",
            authDomain: "wad2-505be.firebaseapp.com",
            databaseURL: "https://wad2-505be-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wad2-505be",
            storageBucket: "wad2-505be.firebasestorage.app",
            messagingSenderId: "221863917439",
            appId: "1:221863917439:web:2a517ca11c83e991388c4a",
            measurementId: "G-L69GG585GF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let user = null;

        // writing to the databse of new reward
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const form = document.getElementById("rewardForm");
                form.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const data = {
                        rewardName: document.getElementById("rewardname").value.trim(),
                        pointsAmount: parseInt(document.getElementById("pointsAmount").value),
                        redeemLimit: parseInt(document.getElementById("redeemLimit").value),
                        redeemedUser: [],
                        createdAt: serverTimestamp()
                    };
                    try {
                        await addDoc(collection(db, "rewards"), data);
                        alert('added successfully')
                    } catch (error) {
                        console.error("Error adding reward", error);
                        alert("Failed to add reward. Check console for details.");
                    }
                });
            } else {
                alert("You must be logged in to manage rewards!");
                window.location.href = "../loginPage_file/login.html";
            }
        });

        //iterate through all rewards, storing them in a table 
        import { getAllRewards, redeemReward, deleteReward, getAllRedeemedUsers } from '../reward/reward.js'
        let rewardTable = document.getElementById('rewardTable')
        let rewardList = await getAllRewards();
        let count = 1
        for (let reward of rewardList) {
            // table building
            let tr = document.createElement('tr')
            rewardTable.appendChild(tr)

            let number = document.createElement("td")
            number.innerText = count;
            count += 1;
            tr.appendChild(number)

            let rewardname = document.createElement("td")
            rewardname.innerText = reward.data.rewardName
            tr.appendChild(rewardname)

            let redeemedUsers = document.createElement("td")
            let button1 = document.createElement("button")
            button1.setAttribute("class", "btn btn-success")
            button1.innerText = "See User Names"
            redeemedUsers.appendChild(button1)
            tr.appendChild(redeemedUsers)

            let td = document.createElement("td")
            let Delete = document.createElement("button")
            Delete.setAttribute("class", "btn btn-danger")
            Delete.innerText = "Delete Reward."
            td.appendChild(Delete)
            tr.appendChild(td)

            //button to see all redeemed users
            button1.addEventListener('click', async () => {
                alert('in console')
                console.log(await getAllRedeemedUsers(reward.id))
            })

            //button to delete reward from firebase
            Delete.addEventListener('click', () => {
                deleteReward(reward.id)
            })
        }
    </script>
</body>

</html>